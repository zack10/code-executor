<div class="app-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <h1>CodeRunner</h1>
      </div>
      <div class="header-actions">
        <select
          [ngModel]="selectedLanguageId()"
          (ngModelChange)="onLanguageChange($event)"
          class="language-select"
        >
          @for (lang of languages; track lang.id) {
            <option [value]="lang.id">
              {{ lang.name }}
            </option>
          }
        </select>
        <button (click)="runCode()" [disabled]="isRunning()" class="run-button">
          @if (!isRunning()) {
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          }
          @if (isRunning()) {
            <svg
              class="spinner"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
          }
          {{ isRunning() ? 'Running...' : 'Run Code' }}
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Code Editor Panel -->
    <div class="editor-panel">
      <div class="panel-header">
        <div class="panel-title">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="16 18 22 12 16 6"></polyline>
            <polyline points="8 6 2 12 8 18"></polyline>
          </svg>
          <span>Code Editor</span>
        </div>
        <span class="file-extension">.{{ currentLanguage()?.ext }}</span>
      </div>
      <div #editorContainer class="code-editor-container"></div>
    </div>

    <!-- Output Panel -->
    <!-- Update your output panel section with this -->

    <div class="output-panel">
      <div class="panel-header">
        <div class="panel-title">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="4 17 10 11 4 5"></polyline>
            <line x1="12" y1="19" x2="20" y2="19"></line>
          </svg>
          <span>{{ isPreviewMode() ? 'Component Preview' : 'Output' }}</span>
        </div>
        @if (executionResult()) {
          <div class="execution-info">
            <span
              class="info-badge"
              [class.success]="executionResult()!.status.id === 3"
              [class.error]="executionResult()!.status.id === 6"
            >
              @if (executionResult()!.status.id === 3) {
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              }
              @if (executionResult()!.status.id === 6) {
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              }
              {{ executionResult()!.status.description }}
            </span>
            @if (executionResult()!.time) {
              <span class="info-badge">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                {{ executionResult()!.time }}s
              </span>
            }
            @if (executionResult()!.memory) {
              <span class="info-badge">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
                  ></path>
                </svg>
                {{ executionResult()!.memory }} KB
              </span>
            }
          </div>
        }
      </div>

      <div class="output-content" [class.has-preview]="isPreviewMode()">
        <!-- Preview iframe - only show when ready -->
        @if (isPreviewMode()) {
          <div
            class="preview-window"
            [style.flex]="consoleVisible() ? '1 1 ' + (100 - consoleHeight()) + '%' : '1 1 100%'"
          >
            <iframe
              #previewFrame
              sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups"
              style="
                width: 100%;
                height: 100%;
                border: none;
                background: white;
                pointer-events: none;
              "
              title="Angular Component Preview"
            >
            </iframe>
          </div>
        }

        <!-- Resizer bar -->
        @if (isPreviewMode() && consoleVisible()) {
          <div class="resize-bar" (mousedown)="startResize($event)" [class.resizing]="isResizing">
            <div class="resize-handle"></div>
          </div>
        }

        <!-- Terminal output -->
        @if (output() && consoleVisible()) {
          <div
            class="terminal-wrapper"
            [style.flex]="'0 0 ' + consoleHeight() + '%'"
            [class.minimized]="consoleMinimized()"
          >
            <div class="terminal-header">
              <div class="status-group">
                @if (isRunning()) {
                  <svg class="spinner-tiny" viewBox="0 0 24 24">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                  </svg>
                  <span>{{ isContainerReady ? 'Syncing...' : 'Booting Engine...' }}</span>
                } @else {
                  <span class="status-ready">‚óè Console</span>
                }
              </div>

              <div class="terminal-controls">
                <button class="control-btn" (click)="minimizeConsole()" title="Minimize">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <button class="control-btn" (click)="maximizeConsole()" title="Maximize">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  </svg>
                </button>
                <button class="control-btn" (click)="copyLogs()" title="Copy">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
                <button class="control-btn" (click)="toggleConsole()" title="Close">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
            </div>

            <pre
              class="output-text"
              #terminalOutput
            ><code>{{ output() | terminalClean }}</code></pre>
          </div>
        }

        @if (!output() && !isRunning()) {
          <div class="empty-state">
            <p>Click "Run Code" to start the environment</p>
          </div>
        }

        <!-- Toggle console button when hidden -->
        @if (!consoleVisible && output()) {
          <button class="show-console-btn" (click)="toggleConsole()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="4 17 10 11 4 5"></polyline>
              <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            Show Console
          </button>
        }
      </div>
    </div>
  </div>
</div>
